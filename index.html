<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OpenTTD Scenario Helper</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  #map {
    position: relative;
  }
  #controls {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255 255 255 / 0.9);
    padding: 8px;
    z-index: 1000;
    border-radius: 4px;
    font-family: sans-serif;
    font-size: 14px;
  }
  #version {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: #666;
  }
  #selection-box {
    position: absolute;
    border: 3px solid orange;
    pointer-events: none;
    box-sizing: border-box;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: none;
    z-index: 999;
    background: rgba(255, 165, 0, 0.1);
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls">
  <label>
    Width (tiles):
    <select id="mapWidth">
      <option>64</option>
      <option>128</option>
      <option>256</option>
      <option selected>512</option>
      <option>1024</option>
      <option>2048</option>
      <option>4096</option>
    </select>
  </label>
  <br />
  <label>
    Height (tiles):
    <select id="mapHeight">
      <option>64</option>
      <option>128</option>
      <option>256</option>
      <option selected>512</option>
      <option>1024</option>
      <option>2048</option>
      <option>4096</option>
    </select>
  </label>
  <br />
  <button id="toggleBoxBtn">Select Heightmap</button>
  <button id="getBoundsBtn">Get Bounds</button>
  <button id="exportBtn">Export JSON</button>
  <input type="file" id="importFile" style="display:none" accept="application/json">
  <button id="importBtn">Import JSON</button>
  <button id="toggleSavedBoundsBtn">Toggle Saved Bounds</button>
  <span id="version"></span>
</div>

<div id="selection-box"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>
<script>
  const APP_VERSION = "v0.1.4";
  document.getElementById('version').textContent = APP_VERSION;

  const map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const selectionBox = document.getElementById('selection-box');
  const toggleBoxBtn = document.getElementById('toggleBoxBtn');
  const getBoundsBtn = document.getElementById('getBoundsBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const toggleSavedBoundsBtn = document.getElementById('toggleSavedBoundsBtn');
  const mapWidthInput = document.getElementById('mapWidth');
  const mapHeightInput = document.getElementById('mapHeight');

  let boxVisible = false;
  let savedBoundsLayer = null;
  let savedBoundsVisible = true;

  function updateSelectionBoxSize() {
    const widthTiles = parseInt(mapWidthInput.value, 10) || 1;
    const heightTiles = parseInt(mapHeightInput.value, 10) || 1;

    const aspectRatio = widthTiles / heightTiles;

    const vw = window.innerWidth;
    const vh = window.innerHeight;

    let boxWidth, boxHeight;

    if (vw / vh > aspectRatio) {
      boxHeight = vh * 0.8;
      boxWidth = boxHeight * aspectRatio;
    } else {
      boxWidth = vw * 0.8;
      boxHeight = boxWidth / aspectRatio;
    }

    selectionBox.style.width = `${boxWidth}px`;
    selectionBox.style.height = `${boxHeight}px`;
  }

  toggleBoxBtn.addEventListener('click', () => {
    boxVisible = !boxVisible;
    selectionBox.style.display = boxVisible ? 'block' : 'none';
    toggleBoxBtn.textContent = boxVisible ? 'Hide Heightmap' : 'Select Heightmap';

    if (boxVisible) {
      updateSelectionBoxSize();
    }
  });

  mapWidthInput.addEventListener('change', () => {
    if (boxVisible) updateSelectionBoxSize();
  });
  mapHeightInput.addEventListener('change', () => {
    if (boxVisible) updateSelectionBoxSize();
  });
  window.addEventListener('resize', () => {
    if (boxVisible) updateSelectionBoxSize();
  });

  function getBoundingBoxLatLng() {
    const box = selectionBox.getBoundingClientRect();
    const mapContainer = map.getContainer().getBoundingClientRect();

    const left = box.left - mapContainer.left;
    const right = box.right - mapContainer.left;
    const top = box.top - mapContainer.top;
    const bottom = box.bottom - mapContainer.top;

    const nw = map.containerPointToLatLng([left, top]);
    const se = map.containerPointToLatLng([right, bottom]);

    return { nw, se };
  }

  function drawSavedBounds(nw, se) {
    if (savedBoundsLayer) {
      map.removeLayer(savedBoundsLayer);
    }
    savedBoundsLayer = L.rectangle([[nw.lat, nw.lng], [se.lat, se.lng]], {
      color: 'blue',
      weight: 2,
      fillOpacity: 0.2
    }).addTo(map);
    if (!savedBoundsVisible) {
      map.removeLayer(savedBoundsLayer);
    }
  }

  getBoundsBtn.addEventListener('click', () => {
    if (!boxVisible) {
      alert("Please enable the heightmap selection box first.");
      return;
    }

    const { nw, se } = getBoundingBoxLatLng();

    alert(`Bounding Box:\nNW: ${nw.lat.toFixed(4)}, ${nw.lng.toFixed(4)}\nSE: ${se.lat.toFixed(4)}, ${se.lng.toFixed(4)}`);
  });

  exportBtn.addEventListener('click', () => {
    if (!boxVisible) {
      alert("Enable the selection box first.");
      return;
    }

    const { nw, se } = getBoundingBoxLatLng();
    const data = {
      version: APP_VERSION,
      mapWidth: mapWidthInput.value,
      mapHeight: mapHeightInput.value,
      bounds: { nw, se },
      center: map.getCenter(),
      zoom: map.getZoom()
    };

    drawSavedBounds(nw, se);

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "openttd_map_selection.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click', () => {
    importFile.click();
  });

  importFile.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);

        mapWidthInput.value = data.mapWidth;
        mapHeightInput.value = data.mapHeight;

        if (data.center && data.zoom) {
          map.setView([data.center.lat, data.center.lng], data.zoom);
        }

        if (data.bounds && data.bounds.nw && data.bounds.se) {
          drawSavedBounds(data.bounds.nw, data.bounds.se);
        }

        if (!boxVisible) {
          boxVisible = true;
          selectionBox.style.display = 'block';
          toggleBoxBtn.textContent = 'Hide Heightmap';
        }

        updateSelectionBoxSize();
        alert("Map selection imported successfully!");
      } catch (err) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  });

  toggleSavedBoundsBtn.addEventListener('click', () => {
    savedBoundsVisible = !savedBoundsVisible;
    if (savedBoundsLayer) {
      if (savedBoundsVisible) {
        map.addLayer(savedBoundsLayer);
      } else {
        map.removeLayer(savedBoundsLayer);
      }
    }
  });
</script>
</body>
</html>
